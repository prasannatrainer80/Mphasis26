package com.java.lib.dao;

import java.sql.Date;
import java.util.List;

import org.hibernate.Criteria;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.Transaction;
import org.hibernate.criterion.Restrictions;

import com.java.lib.model.Books;
import com.java.lib.model.LibUsers;
import com.java.lib.model.TranBook;
import com.java.lib.model.TransReturn;
import com.java.lib.util.SessionHelper;

public class LibraryDaoImpl implements LibraryDao {

	SessionFactory sessionFactory;
	Session session;
	
	@Override
	public int authenticate(LibUsers libUsers) {
		sessionFactory = SessionHelper.getSession(); 
		session = sessionFactory.openSession();
		Criteria cr = session.createCriteria(LibUsers.class);
		cr.add(Restrictions.and(
				Restrictions.eq("userName", libUsers.getUserName()),
				Restrictions.eq("passWord",libUsers.getPassWord())
				));
		LibUsers libFound = (LibUsers)cr.uniqueResult();
		if (libFound !=null) {
			return 1;
		}
		return 0;
	}

	@Override
	public List<Books> search(String searchType, String searchValue) {
		sessionFactory = SessionHelper.getSession(); 
		session = sessionFactory.openSession();
		Criteria cr = session.createCriteria(Books.class);
		if (searchType.equals("id")) {
			cr.add(Restrictions.eq("id", Integer.parseInt(searchValue)));
		} else if (searchType.equals("dept")) {
			cr.add(Restrictions.eq("dept", searchValue));
		} else if (searchType.equals("bookname")) {
			cr.add(Restrictions.eq("name", searchValue));
		} else if (searchType.equals("authorname")) {
			cr.add(Restrictions.eq("author", searchValue));
		}
		return cr.list();
	}
	
	public TranBook issueOrNot(int bookId, String user) {
		sessionFactory = SessionHelper.getSession();
		session = sessionFactory.openSession();
		Criteria cr = session.createCriteria(TranBook.class);
		cr.add(Restrictions.eq("bookId", bookId));
		cr.add(Restrictions.eq("userName", user));
		TranBook tb = (TranBook)cr.uniqueResult();
		return tb;
	}

	@Override
	public String issueBook(int bookId, String user) {
		if (issueOrNot(bookId, user)!=null) {
			return "Book with Id " +bookId + " Already Issued to You";
		}
		sessionFactory = SessionHelper.getSession();
		session = sessionFactory.openSession();
		TranBook tbook = new TranBook();
		tbook.setBookId(bookId);
		tbook.setUserName(user);
		java.util.Date date = new Date();
		Transaction trans = session.beginTransaction();
		session.save(tbook);
		Criteria cr = session.createCriteria(Books.class);
		cr.add(Restrictions.eq("id", bookId));
		Books book = (Books)cr.uniqueResult();
		book.setTotalBooks(book.getTotalBooks()-1);
		session.saveOrUpdate(book);
		trans.commit();
		return "Book with Id " +bookId + " Issued Successfully...\n";
	}

	@Override
	public List<TranBook> showIssuedBooks(String user) {
		sessionFactory = SessionHelper.getSession();
		session = sessionFactory.openSession();
		Criteria cr = session.createCriteria(TranBook.class);
		cr.add(Restrictions.eq("userName", user));
		return cr.list();
	}

	@Override
	public String returnBook(int bookId, String user) {
		sessionFactory = SessionHelper.getSession();
		session = sessionFactory.openSession();
		Transaction trans = session.beginTransaction();
		Criteria cr = session.createCriteria(Books.class);
		cr.add(Restrictions.eq("id", bookId));
		Books book = (Books)cr.uniqueResult();
		book.setTotalBooks(book.getTotalBooks()+1);
		session.saveOrUpdate(book);
		cr = session.createCriteria(TranBook.class);
		cr.add(Restrictions.eq("bookId", bookId));
		TranBook bookFound = (TranBook)cr.uniqueResult();
		session.delete(bookFound);
		TransReturn tr = new TransReturn();
		tr.setBookId(bookFound.getBookId());
		tr.setUserName(user);
		tr.setFromDate(bookFound.getFromDate());
		java.util.Date today = new java.util.Date();
		java.sql.Date sqlDate = new Date(today.getTime());
		tr.setToDate(sqlDate);
		session.save(tr);
		trans.commit();
		return "Book with Id " +bookId + " Returned Successfully...";
	}

	@Override
	public List<TransReturn> history(String user) {
		// TODO Auto-generated method stub
		return null;
	}

}
